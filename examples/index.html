<!DOCTYPE html>
<html lang="en">
<head>
    <title> FBX loader</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
        body {
            font-family: Monospace;
            background-color: #000;
            color: #fff;
            margin: 0px;
            overflow: hidden;
        }
        #info {
            color: #fff;
            position: absolute;
            top: 10px;
            width: 100%;
            text-align: center;
            z-index: 100;
            display: block;
        }
        #info a {
            color: #046;
            font-weight: bold;
        }
    </style>
</head>
<body>
<div class="info" style="text-align: center">
    <button id="changeMat" class="changeMat" onclick="changeMat()"
            style="position: absolute;left: 0;top: 50px;width: 150px;height: 50px;line-height: 30px;cursor: pointer; z-index:10000">
        换面料
    </button>
    <button id="changeCS" class="changeCS" onclick="changeCS()"
            style="position: absolute;left: 0;top: 100px;width: 150px;height: 50px;line-height: 30px;">换衬衫
    </button>
    <button id="changeLZ" class="changeLZ" onclick="changeLZ()"
            style="position: absolute;left: 0;top: 150px;width: 150px;height: 50px;line-height: 30px;">换领子
    </button>
    <button id="changeXKD" class="changeXKD" onclick="changeXKD()"
            style="position: absolute;left: 0;top: 200px;width: 150px;height: 50px;line-height: 30px;">换下口袋
    </button>
    <button id="changeXiongKD" class="changeXiongKD" onclick="changeXiongKD()"
            style="position: absolute;left: 0;top: 250px;width: 150px;height: 50px;line-height: 30px;">换胸口袋
    </button>
    <button id="changeKouZi" class="changeKouZi" onclick="changeKouZi()"
            style="position: absolute;left: 0;top: 300px;width: 150px;height: 50px;line-height: 30px;">换扣子
    </button>
    <button id="changeCSKouzi" class="changeCSKouzi" onclick="changeCSKouzi()"
            style="position: absolute;left: 0;top: 350px;width: 150px;height: 50px;line-height: 30px;">衬衫扣子
    </button>
    <button id="changeShader" class="changeShader" onclick="changeShader(event)"
            style="position: absolute;left: 0;top: 400px;width: 150px;height: 50px;line-height: 30px;">单面渲染
    </button>
</div>
<script src="../build/three.js"></script>
<script src="js/libs/inflate.min.js"></script>
<script src="js/loaders/FBXLoader.js"></script>
<script src="js/jquery.min.js"></script>
<script src="js/controls/OrbitControls.js"></script>
<script src="js/WebGL.js"></script>
<script src="js/libs/stats.min.js"></script>
<script>
    document.getElementById("changeMat").addEventListener("touchstart",function(){
        changeMat()
    });
    document.getElementById("changeCS").addEventListener("touchstart",function(){
        changeCS()
    });
    document.getElementById("changeLZ").addEventListener("touchstart",function(){
        changeLZ()
    });
    document.getElementById("changeXKD").addEventListener("touchstart",function(){
        changeXKD()
    });
    document.getElementById("changeXiongKD").addEventListener("touchstart",function(){
        changeXiongKD()
    });
    document.getElementById("changeKouZi").addEventListener("touchstart",function(){
        changeKouZi()
    });document.getElementById("changeShader").addEventListener("touchstart",function(){
        changeShader()
    });
   document.getElementById("changeCSKouzi").addEventListener("touchstart",function(){
       changeCSKouzi()
    });




    if (WEBGL.isWebGLAvailable() === false) {
        document.body.appendChild(WEBGL.getWebGLErrorMessage());
    }
    var container, stats, controls, loader;
    var camera, scene, renderer, light, hemisphereLight, mixer;
    var clock = new THREE.Clock();
    var modelPluginsdata;//模型属性数据
    var TempModelData = [], partMain = [], partLingZi = [], partXiaKouDai = [], partXiongKouDai = [], partXiuZi = [],
        partMenJin = [], partHouPian = [], partXuanKuanShi = [];//模型实体部件
    var spriteMain, spriteCS, spriteKouzi;//模型部件贴图
    var materialKouzi, materialMain;//实例材质
    var modelpathUrl = "1ModeCololSuit0004";//1ModeCololSuit0007//初始页面时要加载的模型及配置文件名称

    init(modelpathUrl);
    animate();
    var count = 1, mainCount = 1, LZcount = 0, XKDCount = 0;//临时变量/演示用

    function init(modelpathUrl) {
        //构建场景
        container = document.createElement('div');
        document.body.appendChild(container);
        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 30000);
        camera.antialias = true;
        camera.position.set(0, 0, 150);
        scene = new THREE.Scene();
        scene.background = new THREE.TextureLoader().load('textures/bg01.png')
        scene.fog = new THREE.Fog(0xa0a0a0, 200, 1000);
        var ambientLight = new THREE.AmbientLight(0x888888);//添加环境光
        this.scene.add(ambientLight);
        hemisphereLight = new THREE.HemisphereLight(0xffffff, 0x444444);//添加半球光
        hemisphereLight.position.set(50, 50, 400);
        scene.add(hemisphereLight);
        light = new THREE.DirectionalLight(0xffffff);
        light.position.set(0, 9.2,150);
        light.intensity = 1.1;
        scene.add(light);
        controls = new THREE.OrbitControls(camera);
        controls.enablePan = true;
        controls.keyPanSpeed = 7;
        //光源追踪
        controls.addEventListener('change', function () {
            light.position.x = camera.position.x;
            light.position.y = camera.position.y;
            light.position.z = camera.position.z;
            hemisphereLight.position.x = camera.position.x;
            hemisphereLight.position.y = camera.position.y;
            hemisphereLight.position.z = camera.position.z;
        });
        controls.update();
        // model
        $.ajax({
            url: 'models/fbx/' + modelpathUrl + '.json',
            data: {},
            success: function (data) {
                modelPluginsdata = data;
                console.error(data)
            }
        });
        loader = new THREE.FBXLoader();
        loader.load('models/fbx/' + modelpathUrl + '.fbx', function (object01) {
            object01.rotation.set(0, 0, 0);
            object01.scale.set(40, 40, 40);
            object01.position.set(0, -10, 0);
            DefultModelMat();
            modelPluginsdataSeting(object01);
            scene.add(object01);
        });
        renderer = new THREE.WebGLRenderer({antialias: true});
        renderer.setPixelRatio(2);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        container.appendChild(renderer.domElement);
        window.addEventListener('resize', onWindowResize, false);
        // stats
        stats = new Stats();
       // container.appendChild(stats.dom);//关闭状态检测栏
    }
    loader.updatePartMaterial = function (modelParts = [], src, Int) {
        var mapSP = new THREE.TextureLoader().load(src);
        mapSP.wrapS = THREE.RepeatWrapping;
        mapSP.wrapT = THREE.RepeatWrapping;
        mapSP.repeat.set(Int, Int);
        modelParts.forEach(function (child) {
            MatSeting(child.material, mapSP);
        });
    };

    loader.updateMainMaterial = function (src, Int) {

        var mapSP = new THREE.TextureLoader().load(src);
        mapSP.wrapS = THREE.RepeatWrapping;
        mapSP.wrapT = THREE.RepeatWrapping;
        mapSP.repeat.set(Int, Int);
        partMain.forEach(function (child) {
            MatSeting(child.material, mapSP);
        });
    };

    function MatSeting(material, map) {
        material.map = map;
        material.color = new THREE.Color(0x969696);
        material.specular = new THREE.Color(0x040404);
        material.shininess = 20;
        material.side = THREE.DoubleSide;//如果模型没做好出现重叠时重叠区域为黑色
        material.needsUpdate = true;
    }

    function modelPluginsdataSeting(modelParts) {
        ClearPart();
        TempModelData = [];
        modelParts.traverse(function (modelPart) {
            TempModelData.push(modelPart);
        });
        for (var i = 0; i < TempModelData.length; i++) {
            TempModelData[i].tag = modelPluginsdata.modelPluginData[i].tag;
            TempModelData[i].textCode = modelPluginsdata.modelPluginData[i].textCode;
            TempModelData[i].textName = modelPluginsdata.modelPluginData[i].textName;
            TempModelData[i].modelPartType = modelPluginsdata.modelPluginData[i].modelPartType;
            if (TempModelData[i].tag === "part") {
                partMain.push(TempModelData[i]);
            }
            switch (TempModelData[i].modelPartType) {
                case "lingzi":
                    TempModelData[i].visible=false;
                    partLingZi.push(TempModelData[i]);
                    break;
                case "xiakoudai":
                    TempModelData[i].visible=false;
                    partXiaKouDai.push(TempModelData[i]);
                    break;
                case "xiongkoudai":
                    TempModelData[i].visible=false;
                    partXiongKouDai.push(TempModelData[i]);
                    break;
                case "xiuzi":
                    TempModelData[i].visible=false;
                    partXiuZi.push(TempModelData[i]);
                    break;
                case "houpian":
                    TempModelData[i].visible=false;
                    partHouPian.push(TempModelData[i]);
                    break;
                case "menjin":
                    TempModelData[i].visible=false;
                    partMenJin.push(TempModelData[i]);
                    break;
                case "xuankuanshi":
                    TempModelData[i].visible=false;
                    partXuanKuanShi.push(TempModelData[i]);
                    break;
                default:
                    break;
            }
        }
        DefultPart();
        modelParts.traverse(function (item) {
            if (item.isMesh) {
                switch (item.tag) {
                    case "part":
                        item.material = materialMain;
                        break;
                    case "DIYKOUZI":
                        item.material = materialKouzi;
                        break;
                    case "DIYSHOUJINML":
                        // item.material=materialKouzi;
                        break;
                    case "DIYKOUYAN":
                        item.material = materialMain.clone();
                        item.material.map = spriteCS;
                        break;
                    case "DIYXZCS":
                        item.material = materialMain.clone();
                        item.material.map = spriteCS;
                        break;
                    case "DIYXZCSKOUZI":
                        item.material = materialKouzi.clone();
                        break;
                    default:
                        break;
                }
                item.castShadow = true;
            }
        });
    }
    //----------------按钮事件-------------------------
    var myBoolean = Boolean();

    function changeMat() {

        if (mainCount === 1) {
            loader.updateMainMaterial("textures/map01.jpg", 4);
            mainCount = 2;
            return;
        }
        if (mainCount === 2) {
            loader.updateMainMaterial("textures/map3.jpg", 4);
            mainCount = 3;
            return;
        }
        if (mainCount === 3) {
            loader.updateMainMaterial("textures/map4.jpg", 4);
            mainCount = 1;
        }
    }

    function changeCS() {
        if (count === 1) {
            loader.updatePartMaterial(FindPartTag("DIYXZCS"), "textures/cs02.jpg", 4);
            count = 2;
            return;
        }
        if (count === 2) {
            loader.updatePartMaterial(FindPartTag("DIYXZCS"), "textures/cs01.jpg", 4);
            count = 3;
            return;
        }
        if (count === 3) {
            loader.updatePartMaterial(FindPartTag("DIYXZCS"), "textures/chenshan.jpg", 4);
            count = 1;
        }
    }

    function changeKouZi() {

        if (count === 1) {
            loader.updatePartMaterial(FindPartTag("DIYKOUZI"), "textures/kouzi/dayi003.png", 1);
            count = 2;
            return;
        }
        if (count === 2) {
            loader.updatePartMaterial(FindPartTag("DIYKOUZI"), "textures/kouzi/majia001.png", 1);
            count = 3;
            return;
        }
        if (count === 3) {
            loader.updatePartMaterial(FindPartTag("DIYKOUZI"), "textures/kouzi/chenshan001.png", 1);
            count = 1;
        }
    }

    function changeShader(e) {

        if (!myBoolean) {
            e.target.innerHTML = "单面渲染";
            partMain.forEach(function (child) {
                child.material.side = THREE.FrontSide;
            });
            myBoolean = !myBoolean;
        }
        else {
            e.target.innerHTML = "双面渲染";
            partMain.forEach(function (child) {
                child.material.side = THREE.DoubleSide;
            });
            myBoolean = !myBoolean;
        }
    }

    function changeLZ() {

        for (var i = 0; i < partLingZi.length; i++) {
            partLingZi[i].visible = false;
        }
        partLingZi[LZcount].visible = true;
        LZcount += 1;
        if (LZcount === partLingZi.length) {
            LZcount = 0;
        }
    }

    function changeXKD() {

        for (var i = 0; i < partXiaKouDai.length; i++) {
            partXiaKouDai[i].visible = false;
        }
        partXiaKouDai[XKDCount].visible = true;
        XKDCount += 1;
        if (XKDCount === partXiaKouDai.length) {
            XKDCount = 0;
        }
    }

    function changeXiongKD() {

        for (var i = 0; i < partXiongKouDai.length; i++) {
            partXiongKouDai[i].visible = false;
        }
        partXiongKouDai[XKDCount].visible = true;
        XKDCount += 1;
        if (XKDCount === partXiongKouDai.length) {
            XKDCount = 0;
        }
    }

    function changeCSKouzi() {

        if (count === 1) {
            loader.updatePartMaterial(FindPartTag("DIYXZCSKOUZI"), "textures/kouzi/dayi003.png", 1);
            count = 2;
            return;
        }
        if (count === 2) {
            loader.updatePartMaterial(FindPartTag("DIYXZCSKOUZI"), "textures/kouzi/majia001.png", 1);
            count = 3;
            return;
        }
        if (count === 3) {
            loader.updatePartMaterial(FindPartTag("DIYXZCSKOUZI"), "textures/kouzi/chenshan001.png", 1);
            count = 1;
        }
    }
    //-------------我是分割线----------------------
    //清空模型实体部件
    function ClearPart() {
        partLingZi = [];
        partXiaKouDai = [];
        partXiongKouDai = [];
        partXiuZi = [];
        partHouPian = [];
        partMenJin = [];
        partXuanKuanShi = [];
        partMain = [];
    }
    function DefultPart(){

       if (partLingZi.length>0) {
           partLingZi[0].visible=true;
       }
        if (partXiaKouDai.length>0) {
            partXiaKouDai[0].visible=true;
        }
        if (partXiongKouDai.length>0) {
            partXiongKouDai[0].visible=true;
        }
        if (partXiuZi.length>0) {
            partXiuZi[0].visible=true;
        }
        if (partHouPian.length>0) {
            partHouPian[0].visible=true;
        }
        if (partMenJin.length>0) {
            partMenJin[0].visible=true;
        }
        if (partXuanKuanShi.length>0) {
            partXuanKuanShi[0].visible=true;
        }
    }
    //默认材质设置
    function DefultModelMat() {
        spriteMain = new THREE.TextureLoader().load('textures/map2.jpg');
        spriteMain.wrapS = THREE.RepeatWrapping;
        spriteMain.wrapT = THREE.RepeatWrapping;
        spriteMain.repeat.set(4, 4);
        spriteCS = new THREE.TextureLoader().load('textures/chenshan.jpg');
        spriteCS.wrapS = THREE.RepeatWrapping;
        spriteCS.wrapT = THREE.RepeatWrapping;
        spriteCS.repeat.set(4, 4);
        spriteKouzi = new THREE.TextureLoader().load('textures/kouzi/majia001.png');
        materialKouzi = new THREE.MeshLambertMaterial();
        MatSeting(materialKouzi, spriteKouzi);
        materialMain = new THREE.MeshLambertMaterial();
        MatSeting(materialMain, spriteMain);
    }
    //查找指定对象组用于操作
    function FindPartTag(tag) {
        var objs = [];
        TempModelData.forEach(function (item) {
            if (item.tag === tag) {
                objs.push(item)
            }
        });
        return objs;
    }
    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }
    function animate() {
        requestAnimationFrame(animate);
        var delta = clock.getDelta();
        if (mixer) mixer.update(delta);
        renderer.render(scene, camera);
        stats.update();
    }

</script>

</body>
</html>
